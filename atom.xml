<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>iosplayer</title>
  
  
  <link href="http://yoursite.com/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2021-03-12T12:03:38.024Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>John Doe</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>iOS多线程</title>
    <link href="http://yoursite.com/2021/03/12/4/"/>
    <id>http://yoursite.com/2021/03/12/4/</id>
    <published>2021-03-12T08:03:51.000Z</published>
    <updated>2021-03-12T12:03:38.024Z</updated>
    
    <content type="html"><![CDATA[<p>一点点基础知识！</p><a id="more"></a><h1 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h1><p>在之前我们提到，整个列表的数据都是从网络中请求加载到cell当中的，但是由于cell中含有图像的加载的问题，会造成我们App的启动速度十分缓慢和我们在滑动列表的时候产生严重的卡顿，所以接下来我们需要利用线程对列表的滑动体验进行优化。</p><p>优化前的效果</p><p><img src="/images/before.gif"></p><h2 id="线程是什么"><a href="#线程是什么" class="headerlink" title="线程是什么"></a>线程是什么</h2><p>线程是某一进程中一个单独运行的程序。也就是进程的一个实体，是CPU调度和分派的基本单位。</p><h2 id="我们如何使用线程"><a href="#我们如何使用线程" class="headerlink" title="我们如何使用线程"></a>我们如何使用线程</h2><p>在iOS中，线程通常被分为主线程和其他线程。通常我们编写的代码都是在主线程中运行的。为了优化体验，我们需要将图片的加载过程放入到其他线程中，并且在Cell中使用占位图，在非主线程中请求图片数据并加载到Cell上。</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> downloadImageThread = <span class="type">Thread</span>(block: &#123; [<span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                </span><br><span class="line">                rightImage.image = <span class="type">UIImage</span>(data: <span class="keyword">try</span> <span class="type">Data</span>(contentsOf: <span class="type">URL</span>(string: model.thumbnail_pic_s)!))</span><br><span class="line">            &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        downloadImageThread.name = <span class="string">&quot;downloadImageThread&quot;</span></span><br><span class="line">        downloadImageThread.start()</span><br></pre></td></tr></table></figure><p>在写下以上代码之后，可以发现无论是App的启动速度和列表的滑动体验都又了明显的提升。</p><p>效果如下</p><p><img src="/images/after.gif"></p><p>但是我们可以在Xcode中看见系统进行了警告<img src="/images/warn.png"></p><blockquote><p>虽然我们提前放置了占位图，但是任何有关UI的操作都应该放在主线程中进行</p></blockquote><p>所以我们在这里引入另外一个线程的管理方式</p><h2 id="Grand-Central-Dispatch（GCD）"><a href="#Grand-Central-Dispatch（GCD）" class="headerlink" title="Grand Central Dispatch（GCD）"></a>Grand Central Dispatch（GCD）</h2><p>在了解GCD之前，我们需要在这里引入两个概念，<strong>任务</strong>和<strong>队列</strong></p><ul><li>任务：指的是我们需要执行的操作，也就是代码块（block）中的代码。</li><li>队列：指的是执行任务的等待队列，从数据结构中我们知道队列的特点是先进先出，所以我们的任务也是先进先出的。</li></ul><blockquote><p>GCD的优点就是，使开发者从面向线程较为底层的管理变成了面向队列，由系统来为队列从线程池中分配线程执行我们的任务。</p></blockquote><p><img src="/images/thread.png"></p><p>将上述代码改成使用GCD的方式则如下所示</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//全局并发队列</span></span><br><span class="line"><span class="keyword">let</span> downloadQueue = <span class="type">DispatchQueue</span>.global(qos: .<span class="keyword">default</span>)</span><br><span class="line">        <span class="keyword">let</span> mainQueue = <span class="type">DispatchQueue</span>.main</span><br><span class="line">        <span class="comment">//在非主队列中进行网络请求</span></span><br><span class="line">        downloadQueue.async(execute: &#123; [<span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">var</span> modelImage: <span class="type">UIImage?</span> = <span class="literal">nil</span></span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                 modelImage = <span class="type">UIImage</span>(data: <span class="keyword">try</span> <span class="type">Data</span>(contentsOf: <span class="type">URL</span>(string: model.thumbnail_pic_s)!))</span><br><span class="line">            &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//在主队列中进行UI操作</span></span><br><span class="line">            mainQueue.async(execute: &#123; [<span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">                rightImage.image = modelImage</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h2><p><img src="/images/aafter.gif"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;一点点基础知识！&lt;/p&gt;</summary>
    
    
    
    <category term="学习" scheme="http://yoursite.com/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="学习" scheme="http://yoursite.com/tags/%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>沙盒和列表数据缓存</title>
    <link href="http://yoursite.com/2021/03/09/3/"/>
    <id>http://yoursite.com/2021/03/09/3/</id>
    <published>2021-03-09T13:00:54.000Z</published>
    <updated>2021-03-10T09:32:58.534Z</updated>
    
    <content type="html"><![CDATA[<p>继续！</p><a id="more"></a><h1 id="沙盒"><a href="#沙盒" class="headerlink" title="沙盒"></a>沙盒</h1><h2 id="沙盒是什么"><a href="#沙盒是什么" class="headerlink" title="沙盒是什么"></a>沙盒是什么</h2><p><strong>沙盒</strong>：是iOS中每一个应用的独立储存空间。每个应用都只能访问自己沙盒中的文件，无法相互通信。当应用需要请求或接受沙盒外的数据时，都需要经过权限认证，否则无法获取到数据。</p><h2 id="沙盒路径以及文件类型"><a href="#沙盒路径以及文件类型" class="headerlink" title="沙盒路径以及文件类型"></a>沙盒路径以及文件类型</h2><p>在模拟器运行环境下得到的沙盒根路径（每次编译运行都会得到新的沙盒路径，当使用真机运行时则不会生成新的沙盒）</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> homePath = <span class="type">NSHomeDirectory</span>()</span><br><span class="line">        <span class="built_in">print</span>(homePath)</span><br><span class="line"><span class="comment">///Users/wangtao/Library/Developer/CoreSimulator/Devices/FBE21BF5-1A14-4730-8BD1-2E62809CBAD2/data/Containers/Data/Application/007C7152-B54A-419C-8779-C9445B2C67EF</span></span><br></pre></td></tr></table></figure><p>以及沙盒中所包含的文件</p><p><img src="/images/sandbox.png"></p><h2 id="沙盒文件夹的作用"><a href="#沙盒文件夹的作用" class="headerlink" title="沙盒文件夹的作用"></a>沙盒文件夹的作用</h2><h3 id="Documents"><a href="#Documents" class="headerlink" title="Documents"></a>Documents</h3><p>保存持久化的数据，例如用户的登录信息、搜索记录等一些关键数据。系统会为存储在这个文件夹下的数据进行备份</p><h3 id="Library"><a href="#Library" class="headerlink" title="Library"></a>Library</h3><p>Library中包含Caches和Preferences两个文件夹</p><p><img src="/images/Library.png"></p><p><strong>Caches</strong>:用于存储缓存数据，且不会被系统备份</p><p><strong>Preferences</strong>:用于保存持久化数据，NSUserDefaults就存放在此文件夹中，会被系统备份</p><h3 id="SystemData"><a href="#SystemData" class="headerlink" title="SystemData"></a>SystemData</h3><p>新加入到沙盒中的文件，具体作用未知</p><h3 id="tmp"><a href="#tmp" class="headerlink" title="tmp"></a>tmp</h3><p>用于存放临时数据，应用退出时会清除该目录下的数据，且不会被系统备份。</p><h1 id="列表数据缓存"><a href="#列表数据缓存" class="headerlink" title="列表数据缓存"></a>列表数据缓存</h1><p>在理解了沙盒的机制之后，我们将通过沙盒来缓存我们加载到cell的列表数据，以便用户在第二次打开时优先展示本地数据而不是空cell。</p><h2 id="数据归档"><a href="#数据归档" class="headerlink" title="数据归档"></a>数据归档</h2><p>我们需要将网络请求的数据实时储存到沙盒中进行保存。在这里我们将数据写入Lilbrary/Cache/Data/list中</p><ol><li><p>使用<code>NSSearchPathForDirectoriesInDomains</code>获取沙盒路径</p></li><li><p>在沙盒中创建文件夹路径</p></li><li><p>使用<code>FileManager</code>创建目录和文件</p></li><li><p>讲对象（这里是类型数组）序列化成Data</p></li><li><p>将Data写入文件</p></li></ol><p>在此我们引入一个概念<strong>序列化</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">自定义对象是无法写入到文件的，必须转换成二进制流的格式。从对象到二进制数据的过程我们称为序列化，将二进制数据还原成对象的过程，我们称为反序列化。iOS中对象序列化需要实现NSCoding类协议，实现序列化与反序列化方法。</span><br></pre></td></tr></table></figure><p>在此我们通过<code>NSScureCoding</code>实现序列化以及反序列化。</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewsModel</span>: <span class="title">NSObject</span>, <span class="title">NSSecureCoding</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> supportsSecureCoding: <span class="type">Bool</span> = <span class="literal">true</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Coder 转 Obj</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">required</span> <span class="keyword">init</span>?(coder: <span class="type">NSCoder</span>) &#123;</span><br><span class="line">        author_name = coder.decodeObject(forKey: <span class="string">&quot;author_name&quot;</span>) <span class="keyword">as</span>! <span class="type">String</span></span><br><span class="line">        category = coder.decodeObject(forKey: <span class="string">&quot;category&quot;</span>) <span class="keyword">as</span>! <span class="type">String</span></span><br><span class="line">        date = coder.decodeObject(forKey: <span class="string">&quot;date&quot;</span>) <span class="keyword">as</span>! <span class="type">String</span></span><br><span class="line">        thumbnail_pic_s = coder.decodeObject(forKey: <span class="string">&quot;thumbnail_pic_s&quot;</span>) <span class="keyword">as</span>! <span class="type">String</span></span><br><span class="line">        title = coder.decodeObject(forKey: <span class="string">&quot;title&quot;</span>) <span class="keyword">as</span>! <span class="type">String</span></span><br><span class="line">        uniquekey = coder.decodeObject(forKey: <span class="string">&quot;uniquekey&quot;</span>) <span class="keyword">as</span>! <span class="type">String</span></span><br><span class="line">        url = coder.decodeObject(forKey: <span class="string">&quot;url&quot;</span>) <span class="keyword">as</span>! <span class="type">String</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> author_name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> category: <span class="type">String</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> date: <span class="type">String</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> thumbnail_pic_s: <span class="type">String</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> title: <span class="type">String</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> uniquekey: <span class="type">String</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> url: <span class="type">String</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(author_name: <span class="type">String</span>, category: <span class="type">String</span>, date: <span class="type">String</span>, thumbnail_pic_s: <span class="type">String</span>, title: <span class="type">String</span>, uniquekey: <span class="type">String</span>, url: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.author_name = author_name</span><br><span class="line">        <span class="keyword">self</span>.category = category</span><br><span class="line">        <span class="keyword">self</span>.date = date</span><br><span class="line">        <span class="keyword">self</span>.thumbnail_pic_s = thumbnail_pic_s</span><br><span class="line">        <span class="keyword">self</span>.title = title</span><br><span class="line">        <span class="keyword">self</span>.uniquekey = uniquekey</span><br><span class="line">        <span class="keyword">self</span>.url = url</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Obj 转 Coder</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">encode</span><span class="params">(with coder: NSCoder)</span></span> &#123;</span><br><span class="line">        coder.encode(author_name, forKey: <span class="string">&quot;author_name&quot;</span>)</span><br><span class="line">        coder.encode(category, forKey: <span class="string">&quot;category&quot;</span>)</span><br><span class="line">        coder.encode(date, forKey: <span class="string">&quot;date&quot;</span>)</span><br><span class="line">        coder.encode(thumbnail_pic_s, forKey: <span class="string">&quot;thumbnail_pic_s&quot;</span>)</span><br><span class="line">        coder.encode(title, forKey: <span class="string">&quot;title&quot;</span>)</span><br><span class="line">        coder.encode(uniquekey, forKey: <span class="string">&quot;uniquekey&quot;</span>)</span><br><span class="line">        coder.encode(url, forKey: <span class="string">&quot;url&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在实现完Model的协议方法之后，我们将对象序列化成二进制数据</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">archiveData</span><span class="params">(data: [NewsModel])</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> cacheArray = <span class="type">NSSearchPathForDirectoriesInDomains</span>(.cachesDirectory, .userDomainMask, <span class="literal">true</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> cachePath = cacheArray.first &#123;</span><br><span class="line">            <span class="keyword">let</span> fileManager = <span class="type">FileManager</span>.<span class="keyword">default</span></span><br><span class="line">            <span class="keyword">let</span> dataPath = cachePath.appending(<span class="string">&quot;/Data/&quot;</span>)</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> fileManager.createDirectory(atPath: dataPath, withIntermediateDirectories: <span class="literal">true</span>, attributes: <span class="literal">nil</span>)</span><br><span class="line">                <span class="keyword">let</span> listDataPath = dataPath.appending(<span class="string">&quot;list&quot;</span>)</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    <span class="comment">// Obj 转 Data</span></span><br><span class="line">                    <span class="keyword">let</span> listData = <span class="keyword">try</span> <span class="type">NSKeyedArchiver</span>.archivedData(withRootObject: data, requiringSecureCoding: <span class="literal">true</span>)</span><br><span class="line">                    fileManager.createFile(atPath: listDataPath, contents: listData, attributes: <span class="literal">nil</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;error&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>当我们网络请求成功后，我们应该重写本地数据</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">loadNetWork</span><span class="params">(block: @escaping <span class="params">(<span class="params">(Bool, Array&lt;NewsModel&gt;)</span></span></span></span> -&gt; <span class="type">Void</span>)) &#123;</span><br><span class="line">        <span class="comment">// 本地数据加载优先于网络加载</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> localData = loadDataFromLocal() &#123;</span><br><span class="line">            block(<span class="literal">true</span>, localData)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 网络加载</span></span><br><span class="line">        <span class="keyword">let</span> urlString = <span class="string">&quot;http://v.juhe.cn/toutiao/index?type=top&amp;key=1113811726e766953e642681e1371677&quot;</span></span><br><span class="line">        <span class="keyword">let</span> url = <span class="type">URL</span>(string: urlString)!</span><br><span class="line">        <span class="keyword">let</span> session = <span class="type">URLSession</span>.shared</span><br><span class="line">        <span class="keyword">let</span> task = session.dataTask(with: url) &#123; [<span class="keyword">self</span>] data, <span class="keyword">_</span>, error <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">guard</span> error == <span class="literal">nil</span> <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">fatalError</span>(<span class="string">&quot;Task Error&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> jsonData = data <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">fatalError</span>(<span class="string">&quot;Data Error&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="comment">// Data 转 JSON</span></span><br><span class="line">                <span class="keyword">guard</span> <span class="keyword">let</span> dic = <span class="keyword">try</span> <span class="type">JSONSerialization</span>.jsonObject(with: jsonData, options: .allowFragments) <span class="keyword">as</span>? [<span class="type">String</span>: <span class="type">Any</span>] <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">fatalError</span>(<span class="string">&quot;JSONSerialization Error&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">guard</span> <span class="keyword">let</span> resultDic = dic[<span class="string">&quot;result&quot;</span>] <span class="keyword">as</span>? [<span class="type">String</span>: <span class="type">Any</span>] <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">fatalError</span>(<span class="string">&quot;JSONSerialization Error&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">guard</span> <span class="keyword">let</span> dataArray = resultDic[<span class="string">&quot;data&quot;</span>] <span class="keyword">as</span>? [<span class="type">Any</span>] <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">fatalError</span>(<span class="string">&quot;JSONSerialization Error&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">var</span> modelArray = [<span class="type">NewsModel</span>]()</span><br><span class="line">                <span class="keyword">for</span> item <span class="keyword">in</span> dataArray &#123;</span><br><span class="line">                    <span class="keyword">let</span> dic = item <span class="keyword">as</span>! [<span class="type">String</span>: <span class="type">String</span>]</span><br><span class="line">                    <span class="keyword">let</span> model = <span class="type">NewsModel</span>(author_name: dic[<span class="string">&quot;author_name&quot;</span>]!, category: dic[<span class="string">&quot;category&quot;</span>]!, date: dic[<span class="string">&quot;date&quot;</span>]!, thumbnail_pic_s: dic[<span class="string">&quot;thumbnail_pic_s&quot;</span>]!, title: dic[<span class="string">&quot;title&quot;</span>]!, uniquekey: dic[<span class="string">&quot;uniquekey&quot;</span>]!, url: dic[<span class="string">&quot;url&quot;</span>]!)</span><br><span class="line">                    modelArray.append(model)</span><br><span class="line">                &#125;</span><br><span class="line">                archiveData(data: modelArray)</span><br><span class="line">                <span class="comment">// 主线程刷新</span></span><br><span class="line">                <span class="type">DispatchQueue</span>.main.async &#123;</span><br><span class="line">                    block(<span class="literal">true</span>, modelArray)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">                <span class="comment">// error</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        task.resume()</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="反归档"><a href="#反归档" class="headerlink" title="反归档"></a>反归档</h2><p>将本地文件反序列化为对象数组</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">loadDataFromLocal</span><span class="params">()</span></span> -&gt; [<span class="type">NewsModel</span>]? &#123;</span><br><span class="line">        <span class="keyword">let</span> homePath = <span class="type">NSHomeDirectory</span>()</span><br><span class="line">        <span class="built_in">print</span>(homePath)</span><br><span class="line">        <span class="keyword">let</span> cacheArray = <span class="type">NSSearchPathForDirectoriesInDomains</span>(.cachesDirectory, .userDomainMask, <span class="literal">true</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> cachePath = cacheArray.first &#123;</span><br><span class="line">            <span class="comment">// 创建文件管理器</span></span><br><span class="line">            <span class="keyword">let</span> fileManager = <span class="type">FileManager</span>.<span class="keyword">default</span></span><br><span class="line">            <span class="comment">// 文件路径</span></span><br><span class="line">            <span class="keyword">let</span> listDataPath = cachePath.appending(<span class="string">&quot;/Data/list&quot;</span>)</span><br><span class="line">            <span class="comment">// 文件数据加载为Data</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> readListData = fileManager.contents(atPath: listDataPath) &#123;</span><br><span class="line">                <span class="comment">// Data 转 Obj</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> listDataArray = <span class="keyword">try</span>? <span class="type">NSKeyedUnarchiver</span>.unarchivedObject(ofClasses: [<span class="type">NewsModel</span>.<span class="keyword">self</span>, <span class="type">NSArray</span>.<span class="keyword">self</span>], from: readListData) <span class="keyword">as</span>? [<span class="type">NewsModel</span>] &#123;</span><br><span class="line">                    <span class="keyword">return</span> listDataArray</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>当我们开始网络请求之前应该先从本地读取数据加载到cell，优化用户体验</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">loadNetWork</span><span class="params">(block: @escaping <span class="params">(<span class="params">(Bool, Array&lt;NewsModel&gt;)</span></span></span></span> -&gt; <span class="type">Void</span>)) &#123;</span><br><span class="line">       <span class="comment">// 本地数据加载优先于网络加载</span></span><br><span class="line">       <span class="keyword">if</span> <span class="keyword">let</span> localData = loadDataFromLocal() &#123;</span><br><span class="line">           block(<span class="literal">true</span>, localData)</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//网络请求</span></span><br><span class="line">       ....</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h1 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h1><p><img src="/images/sand.gif"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;继续！&lt;/p&gt;</summary>
    
    
    
    <category term="学习" scheme="http://yoursite.com/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="学习" scheme="http://yoursite.com/tags/%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>请求网络json数据并加载到TableViewCell</title>
    <link href="http://yoursite.com/2020/11/27/2/"/>
    <id>http://yoursite.com/2020/11/27/2/</id>
    <published>2020-11-27T13:07:07.000Z</published>
    <updated>2020-11-28T06:19:13.009Z</updated>
    
    <content type="html"><![CDATA[<p>学习不止！</p><a id="more"></a><h2 id="swift写法"><a href="#swift写法" class="headerlink" title="swift写法"></a>swift写法</h2><h3 id="网络请求与数据处理"><a href="#网络请求与数据处理" class="headerlink" title="网络请求与数据处理"></a>网络请求与数据处理</h3><h4 id="网络请求"><a href="#网络请求" class="headerlink" title="网络请求"></a>网络请求</h4><p>利用URL和URLSession.dataTask完成我们的api请求</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> urlString = <span class="string">"http://v.juhe.cn/toutiao/index"</span></span><br><span class="line">       <span class="keyword">let</span> url = <span class="type">URL</span>(string: urlString)!</span><br><span class="line">       <span class="keyword">let</span> session = <span class="type">URLSession</span>.shared</span><br><span class="line">       <span class="keyword">let</span> task = session.dataTask(with: url) &#123; (data, response, error) <span class="keyword">in</span></span><br><span class="line">       </span><br><span class="line">                                              &#125;</span><br></pre></td></tr></table></figure><h4 id="json数据的处理"><a href="#json数据的处理" class="headerlink" title="json数据的处理"></a>json数据的处理</h4><p><img src="/images/blog3-json.png" alt=""></p><p>首先我们需要知道，从网络上请求回来的数据是返回dataTask的data，并且其中还带着一些请求所返回的参数，于是我们接着在dataTaks中将请求回来的数据转换为json数据，然后再利用字典逐步提取其中的我们所需要的数据。</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">guard</span> error == <span class="literal">nil</span> <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">fatalError</span>(<span class="string">"Task Error"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> jsonData = data <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">fatalError</span>(<span class="string">"Data Error"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="comment">// Data 转 JSON</span></span><br><span class="line">                <span class="keyword">guard</span> <span class="keyword">let</span> dic = <span class="keyword">try</span> <span class="type">JSONSerialization</span>.jsonObject(with: jsonData, options: .allowFragments) <span class="keyword">as</span>? [<span class="type">String</span> : <span class="type">Any</span>] <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">fatalError</span>(<span class="string">"JSONSerialization Error"</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//提取JSON中的result</span></span><br><span class="line">                <span class="keyword">guard</span> <span class="keyword">let</span> resultDic = dic[<span class="string">"result"</span>] <span class="keyword">as</span>? [<span class="type">String</span> : <span class="type">Any</span>] <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">fatalError</span>(<span class="string">"JSONSerialization Error"</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//提取result中的data</span></span><br><span class="line">                <span class="keyword">guard</span> <span class="keyword">let</span> dataArray = resultDic[<span class="string">"data"</span>] <span class="keyword">as</span>? [<span class="type">Any</span>] <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">fatalError</span>(<span class="string">"JSONSerialization Error"</span>)</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure><p>由于这只是个人的开发，所以对于错误和数据为空的处理较为简单。接着我们将提取出来的字典数据，转化为model，并且。</p><p><em>model应该创建于一个独立的文件当中</em></p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">NewsModel</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> author_name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> category: <span class="type">String</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> date: <span class="type">String</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> thumbnail_pic_s: <span class="type">String</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> title: <span class="type">String</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> uniquekey: <span class="type">String</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> url: <span class="type">String</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>转化过程的代码应该也在dataTask中</em></p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> modelArray = [<span class="type">NewsModel</span>]()</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> dataArray &#123;</span><br><span class="line">            <span class="keyword">let</span> dic = item <span class="keyword">as</span>! [<span class="type">String</span>: <span class="type">String</span>]</span><br><span class="line">            <span class="keyword">let</span> model = <span class="type">NewsModel</span>(author_name: dic[<span class="string">"author_name"</span>]!, category: dic[<span class="string">"category"</span>]!, date: dic[<span class="string">"date"</span>]!, thumbnail_pic_s: dic[<span class="string">"thumbnail_pic_s"</span>]!, title: dic[<span class="string">"title"</span>]!, uniquekey: dic[<span class="string">"uniquekey"</span>]!, url: dic[<span class="string">"url"</span>]!)</span><br><span class="line">            modelArray.append(model)</span><br></pre></td></tr></table></figure><p>到此我们已经完成了第一步，网络请求和数据处理。接下来就是讲数据传递到cell中并加载数据。</p><h2 id="数据加载到cell"><a href="#数据加载到cell" class="headerlink" title="数据加载到cell"></a>数据加载到cell</h2><h4 id="加载的顺序"><a href="#加载的顺序" class="headerlink" title="加载的顺序"></a>加载的顺序</h4><pre class="mermaid">graph LR视图控制器创建网络请求并在子线程中执行 --> 网络请求获取数据并传入视图控制器网络请求获取数据并传入视图控制器 --> 主线程重加载cell的数据</pre><h4 id="数据的传递"><a href="#数据的传递" class="headerlink" title="数据的传递"></a>数据的传递</h4><p>首先我们需要在网络请求的方法中传入一个闭包用于传递数据，并且由于需要将数据的刷新加载至主线程中所以闭包必须是逃逸闭包</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">loadNetWork</span><span class="params">(block: @escaping <span class="params">(<span class="params">(Bool, Array&lt;NewsModel&gt;)</span></span></span></span> -&gt; <span class="type">Void</span>)) &#123;</span><br><span class="line">  ...</span><br><span class="line">  ...</span><br><span class="line">  <span class="type">DispatchQueue</span>.main.async &#123;</span><br><span class="line">                block(<span class="literal">true</span>, modelArray)</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同时我们在cell中也要创建一个传递数据的方法</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public func modelForCell(model: NewsModel) &#123;</span><br><span class="line">        titleLabel.text &#x3D; model.title</span><br><span class="line">        sourceLabel.text &#x3D; model.category</span><br><span class="line">        commentLabel.text &#x3D; model.author_name</span><br><span class="line">        timeLabel.text &#x3D; model.date</span><br><span class="line">        do &#123;</span><br><span class="line">            rightImage.image &#x3D; UIImage(data: try Data(contentsOf: URL(string: model.thumbnail_pic_s)!))</span><br><span class="line">        &#125; catch &#123;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>在控制器中，我们需要创建网络请求，并且在cell的注册方法中调用modelForCell(model: NewsModel)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">override func viewDidLoad() &#123;</span><br><span class="line">        super.viewDidLoad()</span><br><span class="line">        view.addSubview(newsTableView)</span><br><span class="line">        let loader &#x3D; ListLoder()</span><br><span class="line">        loader.loadNetWork &#123; (success, model) in</span><br><span class="line">            self.data &#x3D; model</span><br><span class="line">            self.newsTableView.reloadData()</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F;extnsion</span><br><span class="line">            func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -&gt; UITableViewCell &#123;</span><br><span class="line">        let cell &#x3D; tableView.dequeueReusableCell(withIdentifier: &quot;reusedcell&quot;) as! NewsTableViewCell</span><br><span class="line">        cell.modelForCell(model: data[indexPath.row])</span><br><span class="line">        return cell</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>到此，我们就已经完成了整个数据从网络请求到加载到cell当中，由于我个人的实力问题，部分代码还无法进行很好的解释，在后续的学习当中我会更新讲解</p><h2 id="附上最后的效果"><a href="#附上最后的效果" class="headerlink" title="附上最后的效果"></a>附上最后的效果</h2><p><img src="/images/blog3-final.png" alt=""></p><p><a href="https://github.com/jacktaonb/SampleAppForSwift.git" target="_blank" rel="noopener">附上我的仓库地址</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;学习不止！&lt;/p&gt;</summary>
    
    
    
    <category term="学习" scheme="http://yoursite.com/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="学习" scheme="http://yoursite.com/tags/%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
</feed>
